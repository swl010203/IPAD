<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/iconfont.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/mall_estate.css"/>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav bgwhite">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left colorRed"></a>
			<h1 class="mui-title inp_muiTitle inp_muiTitle_fenlei colorRed">商店</h1>
		</header>
		<div class="mui-content bgwhite">
			<div class="ztcs_lunbo shop_lunbo">
				<div class="mui-slider">
					<div class="mui-slider-group mui-slider-loop" id="shopBanner">
						<!--<div class="mui-slider-item mui-slider-item-duplicate">
							<div class="ztcs_topImg bgwhite">
								<img src="../../images/wy1.jpg"/>
							</div>
						</div>
						<div class="mui-slider-item">
							<div class="ztcs_topImg bgwhite">
								<img src="../../images/wy1.jpg"/>
							</div>
						</div>
						<div class="mui-slider-item">
							<div class="ztcs_topImg bgwhite">
								<img src="../../images/wy1.jpg"/>
							</div>
						</div>
						<div class="mui-slider-item mui-slider-item-duplicate">
							<div class="ztcs_topImg bgwhite">
								<img src="../../images/wy1.jpg"/>
							</div>
						</div>-->
					</div>
				</div>
			</div>
			<div class="main shop_list margin_bottom">
				<div class="left-menu">
					<ul id="cateOne">
						<!--<li class="active">营养套餐</li>
						<li class="">酒水饮料</li>
						<li>酒水饮料</li>
						<li>酒水饮料</li>
						<li>酒水饮料</li>-->
					</ul>
				</div>
				<div class="con clearfloat">
					<div class="right-con" style="display: block;">
						<ul id="categoods">
							<!--<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁宫保鸡丁宫保鸡丁宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>-->
						</ul>
					</div>
					<!--<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="right-con" style="display: none;">
						<ul>
							<li>
								<div class="menu-img"><img src="../../images/bwm3.jpg" width="55" height="55"></div>
								<div class="menu-txt">
									<h4 class="mui-ellipsis">宫保鸡丁</h4>
									<p class="list2"><b>￥25</b></p>
									<div class="btn">
										<span class="iconfont icon-jian minus colorRed"></span>
										<i>0</i>
										<span class="iconfont icon-jia add colorRed"></span>
									</div>
								</div>
							</li>
						</ul>
					</div>-->
				</div>
			</div>
		</div>
		<div style="height: 50px;"></div>
		<footer style="z-index: 100004;" class="cart_footer clearfloat fs24 mui-row pl20 box_s border_t">
			<div class="mui-col-sm-9 mui-col-xs-9">
				<div class="bianjiClick_div">
					<p style="line-height: 50px;">
						<span class="iconfont icon-cart posRel colorRed cart_click"><span class="mui-badge mui_badge znum">0</span></span>
						<span class="colorHui999 mui-hidden null_cartSpan">购物车空空如也</span>
						<span class="full_cartSpan">
							<span class="fs28 colorBlack">￥</span>
							<span class="fs36 colorBlack zprice">0.00</span> 
						</span>
					</p>
				</div>
			</div>
			<div class="mui-col-sm-3 mui-col-xs-3">
				<div class="buyNow mui-text-center colorWhite submit_order" id="tijiaodingdan">提交订单</div>
			</div>
		</footer>
		<div class="mark_common mui-hidden">
			<div style="display: none;" class="outer_markMark">
				<div class="clearfloat fs24 pt10 pb10 border_b bgColorf2 pl20 pr20 box_s colorHui999	">
					<span>共2件商品</span>
					<span class="mui-pull-right clearCart_click" onclick="clearCart();"><span style="vertical-align: -1px;" class="iconfont icon-shanchu mr10"></span>清空购物车</span>
				</div>
				<div class="mui-scroll-wrapper shop_mark">
					<div class="mui-scroll">
						<!--这里放置真实显示的DOM内容-->
						<div class="shop_mark_inner">
							<ul class="shop_mark_inner_ul pl20 pr20 box_s" id="cartGoods">
								<!--<li class="clearfloat border_b">
									<div class="mui-pull-left shop_mark_inner_ul_l fs28">
										<p class="mt20">JBL专业跑步运动耳机</p>
										<p class="font_weightB">￥399.00</p>
									</div>
									<div class="mui-pull-left shop_mark_inner_ul_r">
										<div class="btn mt30">
											<span class="iconfont icon-jian minus colorRed"></span>
											<i>10</i>
											<span class="iconfont icon-jia add colorRed"></span>
										</div>
									</div>
								</li>-->
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../script/mui.min.js"></script>
	<script type="text/javascript" src="../../script/jquery_2_1_4.js"></script>
	<script type="text/javascript" src="../../script/common.js"></script>
	<script type="text/javascript" src="../../script/app.js"></script>
	<script type="text/javascript">
		mui.init();
//		setTimeout(function(){
//		    var gallery = mui('.ztcs_lunbo');
//		    gallery.slider({
//		         interval:1800//自动轮播周期，若为0则不自动播放，默认为0；
//		    });
//		},300)
		// //加的效果
		// $(".add").click(function () {
		// 	$(this).prevAll().css("display", "inline-block");
		// 	var n = $(this).prev().text();
		// 	var num = parseInt(n) + 1;
		// 	if (num == 0) { return; }
		// 	$(this).prev().text(num);
		// 	var danjia = $(this).next().text();//获取单价
		// 	var a = $("#totalpriceshow").html();//获取当前所选总价
		// 	$("#totalpriceshow").html((a * 1 + danjia * 1).toFixed(2));//计算当前所选总价
		// 	var nm = $("#totalcountshow").html();//获取数量
		// 	$("#totalcountshow").html(nm*1+1);
		// });
		// //减的效果
		// $(".minus").click(function () {
		// 	var n = $(this).next().text();
		// 	var num = parseInt(n) - 1;
		// 	$(this).next().text(num);//减1
		// 	var danjia = $(this).nextAll(".price").text();//获取单价
		// 	var a = $("#totalpriceshow").html();//获取当前所选总价
		// 	$("#totalpriceshow").html((a * 1 - danjia * 1).toFixed(2));//计算当前所选总价
		// 	var nm = $("#totalcountshow").html();//获取数量
		// 	$("#totalcountshow").html(nm * 1 - 1);
		// 	//如果数量小于或等于0则隐藏减号和数量
		// 	if (num <= 0) {
		// 		$(this).next().css("display", "none");
		// 		$(this).css("display", "none");
		// 		 return
		// 	}
		// });
		//列表选项卡
		$(".left-menu li").click(function(){
			$(this).addClass("active").siblings().removeClass("active");
			var n = $(this).index();
			$(".con .right-con").hide();
			$(".con .right-con").eq(n).show();
		});
		//初始化scroll控件
		mui('.mui-scroll-wrapper').scroll();
		//购物车
		$(".cart_click").on("tap",function(){
			if($(this).hasClass("colorRed")){
				$(".mark_common").removeClass("mui-hidden");
				$(".outer_markMark").slideDown();
				show_mark();
				getCart();
				// $(".mark_common").removeClass("mui-hidden");
				// $(".outer_markMark").slideDown();
				// show_mark();
			}
		});
		$(".outer_markMark").on("tap",function(e){
			e.stopPropagation();
		});
		$(".mark_common").on("tap",function(){
			$(".outer_markMark").slideUp(function(){
				$(".mark_common").addClass("mui-hidden");
			});
			hidden_mark();
		});
		//清空购物车
		// $(".clearCart_click").on("tap",function(){
		// 	$(".outer_markMark").remove();
		// 	$(".mark_common").addClass("mui-hidden");
		// 	$(".cart_click").removeClass("colorRed").addClass("colorHui999");
		// 	$(".cart_click").find("span").addClass("mui-hidden");
		// 	$(".null_cartSpan").removeClass("mui-hidden");
		// 	$(".full_cartSpan").addClass("mui-hidden");
		// 	$(".submit_order").addClass("bgcolorCcc").removeClass("buyNow");
		// })
		var uid = '';
		apiready  = function(){
			api.addEventListener({
			    name: 'keyback'
			}, function(ret, err){
			    fanhui();
			});
			api.addEventListener({
	            name:'refresh_ecartinfo'
            },function(ret,err){
            	getCartInfo();
            });
            api.addEventListener({
	            name:'event_ecart_num'
            },function(ret,err){
            	getCartInfo();
            });
			uid = localStorage.getItem('uid');
			getShopDetail();
			getBanner();
		};

		//商城详情
		function getShopDetail(){
			_ajax(ajax_url+"Index/ExerciseShop/getShopDetail",{'uid':uid},'post',function(ret){
				if(ret.status==1){
					var cateOnehtml='';
					$.each(ret.data,function(k,v){
						if(k == 0){
							cateOnehtml+='<li class="active" onclick="getGoodsByCategory('+v.id+',this)">'+v.title+'</li>';
							getGoodsByCategory(v.id);
						}else{
							cateOnehtml+='<li onclick="getGoodsByCategory('+v.id+',this)">'+v.title+'</li>';
						}
					});
					if(ret.cart['num']){
						$('.znum').html(ret.cart.num);
						$('.zprice').html(ret.cart.price);
					}
					$('#cateOne').html(cateOnehtml);
					libiaoxuanxiang();
				}
			});
		}

		//获取分类下商品
		function getGoodsByCategory(cate_id,el){
			_ajax(ajax_url+"Index/ExerciseShop/getGoodsByCategory" ,{'cid':cate_id},'get',function(ret){
				var strVar = "";
				if(ret.code !=1){
					$("#categoods").html(strVar);
					 return false;
				}
				$.each(ret.data[0].goods,function(k,v){
					strVar += '		<li>';
					strVar += '			<div class="menu-img"><img src="'+v.pic_path+'" width="55" height="55" onclick="goodsDetail('+v.goods_id+');"></div>';
					strVar += '			<div class="menu-txt">';
					strVar += '				<h4 class="mui-ellipsis">'+v.goods_name+'</h4>';
					strVar += '				<p class="list2"><b>￥'+v.shop_price+'</b></p>';
					strVar += '				<div class="btn">';
					strVar += '					<span class="iconfont icon-jian minus colorRed" data-goods-id="'+v.goods_id+'"></span>';
					strVar += '					<i>0</i>';
					strVar += '					<span class="iconfont icon-jia add colorRed" data-goods-id="'+v.goods_id+'"></span>';
					strVar += '				</div>';
					strVar += '			</div>';
					strVar += '		</li>';
				});
				$("#categoods").html(strVar);
				jiajian();
			});
		}
		//获取购物车信息
		function getCartInfo(){
			uid = localStorage.getItem("uid");
			if(typeof uid ==undefined || uid ==''  || uid ==null){
				return false;
			}

			_ajax(ajax_url+"Index/ExerciseShop/getCartInfo",{'uid':uid},'post',function(ret){
				if(ret.status==1){
					$(".znum").html(ret.data.znum);
					$(".zprice").html(ret.data.zprice);
				}
			});

		}
		// 商品列表选项卡效果
		function libiaoxuanxiang(){
			//列表选项卡
			$(".left-menu li").click(function(){
				$(this).addClass("active").siblings().removeClass("active");
				// var n = $(this).index();
				// $(".con .right-con").hide();
				$(".con .right-con").show();
			});
		}

		function getCart(){
			// alert(11);
			if(typeof uid ==undefined || uid ==''  || uid ==null){
				return false;
			}

			_ajax(ajax_url+'Index/ExerciseShop/getCart',{'uid':uid},'post',function(ret){
				if(ret.status == 1){
					var cartGoods = '';
					$.each(ret.data,function(k,v){
						cartGoods += '<li class="clearfloat border_b">';
						cartGoods += '	<div class="mui-pull-left shop_mark_inner_ul_l fs28">';
						cartGoods += '		<p class="mt20">'+v.goods_name+'</p>';
						cartGoods += '		<p class="font_weightB">￥'+v.goods_price+'</p>';
						cartGoods += '	</div>';
						cartGoods += '	<div class="mui-pull-left shop_mark_inner_ul_r">';
						cartGoods += '		<div class="btn mt30">';
						cartGoods += '			<span class="iconfont icon-jian minus colorRed" data-goods-id="'+v.gid+'"></span>';
						cartGoods += '			<i>'+v.num+'</i>';
						cartGoods += '			<span class="iconfont icon-jia add colorRed" data-goods-id="'+v.gid+'"></span>';
						cartGoods += '		</div>';
						cartGoods += '	</div>';
						cartGoods += '</li>';
					});
					$('#cartGoods').html(cartGoods);
					jiajian();
				}
			});
		}

		//加减商品效果
		function jiajian(){
			//加的效果
			$(".add").click(function () {
				if( uid == '' || uid == 0 || uid == null || typeof uid == 'undefined' ) {
					_openWinByUrl('login' , '../../login');
		            return false;
		        }
				var goodsIdStr = $(this).attr( 'data-goods-id' );
		        var goodsNumStr = 1;//$("#goods_id_" + goodsIdStr).attr( 'data-goods-num' );
				$(this).prevAll().css("display", "inline-block");
				var n = $(this).prev().text();
				var num = parseInt(n) + 1;
				if (num == 0) { return; }
				$(this).prev().text(num);
				addCart(goodsIdStr , goodsNumStr);
			});
			//减的效果
			$(".minus").click(function () {
				var goodsIdStr = $(this).attr( 'data-goods-id' );
		        var goodsNumStr = -1;//$("#goods_id_" + goodsIdStr).attr( 'data-goods-num' );
				var n = $(this).next().text();
				var num = parseInt(n) - 1;
				$(this).next().text(num);//减1
				addCart(goodsIdStr , goodsNumStr);
				//如果数量小于或等于0则隐藏减号和数量
				if (num <= 0) {
					$(this).next().css("display", "none");
					$(this).css("display", "none");

				}
			});
		}


		function addCart(goods_id , goods_num ){
			if( uid == '' || uid == 0 || uid == null || typeof uid == 'undefined' ) {
				_openWinByUrl('login' , '../../login');
	            return false;
	        }

	        if( goods_id == '' || goods_num == '' ) {
	            _toast( '请选择商品' );
	            return false;
	        }

			_ajax(ajax_url+"Index/ExerciseShop/addCart" ,{uid:uid, goods_id:goods_id, goods_num:goods_num},'post',function(ret) {
				// alert(JSON.stringify(ret));
	            if(ret.status == 1){
	            	var nm = $(".znum").html();//获取数量
	            	if(goods_num > 0 ){
	            		$(".znum").html(nm*1+1);
	            	} else {
	            		$(".znum").html(nm*1-1);
	            	}
	            	total_price = ret.total_price * 1;

	            	if( total_price > 0 ) {
						$("#aa").addClass('outer_markMark');
						$(".cart_click").addClass("colorRed").removeClass("colorHui999");
						$(".cart_click").find("span").removeClass("mui-hidden");
						$(".null_cartSpan").addClass("mui-hidden");
						$(".full_cartSpan").removeClass("mui-hidden");
						$(".submit_order").removeClass("bgcolorCcc").addClass("buyNow");
	                }
	            	$(".zprice").html( total_price.toFixed(2) );//计算当前所选总价
	            }else{
	                //_toast(ret.msg);
	            }
	        });
		}
		
		    // 获取轮播banner
    function getBanner(){
        _ajax(ajax_url+'Index/ExerciseShop/shopTopBanner', {}, 'get', function(ret){
            if(ret.status == 1){
                // 获取宣传图成功
                var banner_html = '';
                var logoNum = ret.data.length-1;
                
                banner_html+='<div class="mui-slider-item mui-slider-item-duplicate">';
				banner_html+='			<div class="ztcs_topImg bgwhite">';
				banner_html+='				<img src="'+ret.data[logoNum].pic+'"/>';
				banner_html+='			</div>';
				banner_html+='		</div>';

                $.each(ret.data, function(k, v){
                banner_html+='<div class="mui-slider-item">';
				banner_html+='			<div class="ztcs_topImg bgwhite">';
				banner_html+='				<img src="'+v.pic+'"/>';
				banner_html+='			</div>';
				banner_html+='		</div>';
                });
                banner_html+='<div class="mui-slider-item mui-slider-item-duplicate">';
				banner_html+='			<div class="ztcs_topImg bgwhite">';
				banner_html+='				<img src="'+ret.data[0].pic+'"/>';
				banner_html+='			</div>';
				banner_html+='		</div>';
                $('#shopBanner').html(banner_html);
                setTimeout(function(){
				    var gallery = mui('.ztcs_lunbo');
				    gallery.slider({
				         interval:1800//自动轮播周期，若为0则不自动播放，默认为0；
				    });
				},300)
            }
        });
    }
    
    
		$('.mui-action-back').on('tap',function(){
			fanhui();
		});
		function fanhui(){
			api.closeWin();
		}
		//清空购物车
		function clearCart(){
//			$(".outer_markMark").remove();
			$(".mark_common").addClass("mui-hidden");
//			$(".cart_click").removeClass("colorRed").addClass("colorHui999");
//			$(".cart_click").find("span").addClass("mui-hidden");
//			$(".null_cartSpan").removeClass("mui-hidden");
//			$(".full_cartSpan").addClass("mui-hidden");
			$("#cartGoods").html("");
			$(".submit_order").addClass("bgcolorCcc").removeClass("buyNow");
			clearAllCart();
		}
		//执行清空购物车
		function clearAllCart(){
			if( uid == '' || uid == 0 || uid == null || typeof uid == 'undefined' ) {
				_openWinByUrl('login' , '../../login');
				return false;
			}
			_ajax(ajax_url+'Index/ExerciseShop/clearAllCart',{'uid':uid},'post',function(ret){
				if(ret.status == 1){
					getShopDetail();
				}
			});
		}
		$('#tijiaodingdan').on('tap',function(){
			_openWinByUrl('sureOrder','sureOrder');
		});
		function goodsDetail(id){
			_openWinByUrl('goodsDetail','goodsDetail',{'goods_id':id});
		}
	</script>
</html>
