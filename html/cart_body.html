<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>title</title>
    <link href="../css/style.css" rel="stylesheet" type="text/css" />
<link href="../css/index.css" rel="stylesheet" type="text/css" />
<link href="../css/h_index.css" rel="stylesheet" type="text/css" />
    <style>
    	body{
    		
    	}
    	.busi_fenleirrice {
		
			padding-top: 20px;
		}
		.siteSearchul{
			padding-left: 20px;
			box-sizing:border-box;
		}
		.duo_checkbox03:checked + label:after {
			height: 30px;
			background: url(../images/this_01.png) no-repeat 0px 0px;
			background-size: 30px 30px;
			position: absolute;
			left: -14px;
			top: 0px;
			content: ' ';
			line-height: 20px;
			padding-right: 0.46rem;
			color: #d12a18;
		}
		.busi_fenleia {
			float: left;
			width: 16%;
			display: inline-block;
		}
		.duo_checkbox03:checked + label:after {
			left: -1px;
		}
		.cartNumc{width:39px;}
    </style>
</head>
<body>
<div class="wp_100" id="cartList">

	<!--
	<div class="cart_topicon"><img src="../images/cart_pinpaiicon.jpg"/>柏卡姿专卖店</div>
	<div class="siteSearchlist" style="background:#fff;">
		<ul class="siteSearchul siteSearchuledit">
				<li class="busi_fenleili">
						<div class="busi_fenlei">
						<a href="#"class="busi_fenleia"><img src="../images/busi_fenlei.png"></a>
						<div class="busi_fenleir">
							<p class="busi_fenleirtxt"><a href="#" class="busi_fenleirtxta dy_dd">杏仁蜡菊保湿霜50g</a></p>
							<p class="busi_fenleirrice"><b class="busi_fenleirpriceb">￥</b>88.00</p>
						</div>
					</div>
					<a href="javascript:;" class="cartNum">
						<span class="cartNuml cartNumldis"></span>
						<span class="cartNumc">3</span>
						<span class="cartNumr"></span>
					</a>
					<div class="cartRadio">
						<input id="a_pl1" type="checkbox" name="test" value="3" class="duo_checkbox03">
						<label for="a_pl1"></label>
					</div>
				</li>
				<li class="busi_fenleili">
						<div class="busi_fenlei">
						<a href="#"class="busi_fenleia"><img src="../images/busi_fenlei.png"></a>
						<div class="busi_fenleir">
							<p class="busi_fenleirtxt"><a href="#" class="busi_fenleirtxta dy_dd">杏仁蜡菊保湿霜50g</a></p>
							<p class="busi_fenleirrice"><b class="busi_fenleirpriceb">￥</b>88.00</p>
						</div>
					</div>
					<a href="javascript:;" class="cartNum">
						<span class="cartNuml cartNumldis"></span>
						<span class="cartNumc">3</span>
						<span class="cartNumr"></span>
					</a>
					<div class="cartRadio" style="color: #333;line-height: 1.7rem;    padding-left: 0.1rem;">
						失效
					</div>
				</li>
			
		</ul>
	</div>


<div class="cart_topicon"><img src="../images/cart_pinpaiicon.jpg"/>柏卡姿专卖店</div>
	<div class="siteSearchlist" style="background:#fff;">
		<ul class="siteSearchul siteSearchuledit" >
				<li class="busi_fenleili">
						<div class="busi_fenlei">
						<a href="#"class="busi_fenleia"><img src="../images/busi_fenlei.png"></a>
						<div class="busi_fenleir">
							<p class="busi_fenleirtxt"><a href="#" class="busi_fenleirtxta dy_dd">杏仁蜡菊保湿霜50g</a></p>
							<p class="busi_fenleirtxt"><a></a>杏仁蜡菊保湿霜50g</p>
							<p class="busi_fenleirrice"><b class="busi_fenleirpriceb">￥</b>88.00</p>
						</div>
					</div>
					<a href="javascript:;" class="cartNum">
						<span class="cartNuml cartNumldis"></span>
						<span class="cartNumc">3</span>
						<span class="cartNumr"></span>
					</a>
					<div class="cartRadio">
						<input id="a_pl1" type="checkbox" name="test" value="3" class="duo_checkbox03">
						<label for="a_pl1"></label>
					</div>
				</li>
				<li class="busi_fenleili">
						<div class="busi_fenlei">
						<a href="#"class="busi_fenleia"><img src="../images/busi_fenlei.png"></a>
						<div class="busi_fenleir">
							<p class="busi_fenleirtxt"><a href="#" class="busi_fenleirtxta dy_dd">杏仁蜡菊保湿霜50g</a></p>
							<p class="busi_fenleirrice"><b class="busi_fenleirpriceb">￥</b>88.00</p>
						</div>
					</div>
					<a href="javascript:;" class="cartNum">
						<span class="cartNuml cartNumldis"></span>
						<span class="cartNumc">3</span>
						<span class="cartNumr"></span>
					</a>
					<div class="cartRadio" style="color: #333;line-height: 1.7rem;    padding-left: 0.1rem;">
						失效
					</div>
				</li>
			
		</ul>
	</div>-->
	
</div>

<div class="is_putaway" style="padding-top: 20px; display: none;">
			<div class="bqt_hallorder">
			<a href="javascript:void(0)" onclick="setType(3);" class="bot_btna bot_btnapay order_btnapay" style="border-radius: 5px;">清空失效</a>
			</div>
	</div>
</body>

<script type="text/javascript" src="../script/jquery_2_1_4.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/app.js"></script>
<script type="text/javascript">
	var userinfo="";
	var frame="";
	
	var edit_type = 0; //是否编辑状态 1是 0否
	var allCheck = 0;  //是否全选择
	apiready = function(){
	
		var parframe = api.pageParam.frame_name;
		if(parframe != undefined && typeof parframe !=undefined){
			frame = parframe;
		}
		is_hide = api.pageParam.is_hide;

		if(is_hide ==1){
			api.setFrameAttr({
				 name: 'cart_body',
				 hidden:false
			})
		}else{
			api.setFrameAttr({
				 name: 'cart_body',
				 hidden:true
			})
		}
		/*
		api.addEventListener({
	        name:'refresh_cartinfo'
        },function(ret,err){
        	total_price = 0;
			getCart();
        });*/
       api.addEventListener({
	        name:'refresh_order_cartinfo'
        },function(ret,err){
        	total_price = 0;
			getCart();
        });
       
        
        api.addEventListener({
		    name:'viewappear'
		}, function(ret, err){        
		   	total_price = 0;
			getCart();
		});
		

		
		api.parseTapmode();
		userinfo = $api.getStorage('userinfo');
		//加载状态
		loading('cart_body');
		api.setRefreshHeaderInfo({
		    visible: true,
		    loadingImg: 'widget://image/refresh.png',
		    bgColor: '#ccc',
		    textColor: '#fff',
		    textDown: '下拉刷新...',
		    textUp: '松开刷新...',
		    showTime: true
		}, function(ret, err) {
			total_price = 0;
		    //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
			getCart();
		});
		
		//监听更新登陆信息
		api.addEventListener({
		    name: 'refresh_userinfo'
		}, function(ret, err) {
		    userinfo = ret.value.userinfo;
		});

		//去结算
		api.addEventListener({
	        name:frame+'cartOrder'
        },function(ret,err){
        	order();
        });
        
        //编辑购物车
        api.addEventListener({
	        name:frame+'edit_cart'
        },function(ret,err){
        	edit_type = ret.value.type;  //
        	$(".duo_checkbox03").removeAttr('checked');
        	if(edit_type ==1){
        		$(".goods_edit").hide();
        		$(".goods_edit_show").show();
        	}else{
        		$(".goods_edit").show();
        		$(".goods_edit_show").hide();
        	}
        	
        	//coding...
        });
        
		//删除购物车商品
		api.addEventListener({
	        name:frame+'indexdelsCart'
        },function(ret,err){
        	delsCart();
        });
        
        
        api.addEventListener({
	        name:frame+'CheckAllEdit'
        },function(ret,err){
        	//coding...
        	var allCheck =ret.value.type; 
        	shopCheckAllEdit(allCheck);
        });
        
        api.addEventListener({
	        name:frame+'CheckAll'
        },function(ret,err){
        	//coding...
        	allCheck =ret.value.type; 
        	
        	shopCheckAll(allCheck);
        });
	
		if(typeof userinfo ==undefined || userinfo ==''  || userinfo ==null){
			//空购物车
			emptyCart();
			api.sendEvent({
		        name:frame+'cartPrice',
		         extra:{
	            	price:total_price.toFixed(2)
	            }
	        });
			api.refreshHeaderLoadDone();
			closeloading();
		}else{
			getCart();
		}
		
	};
	
	var total_price = 0.00;  //总价
	
	/**
	 * 获取购物车信息 
	 */
	function getCart(){
		userinfo = $api.getStorage('userinfo');
		if(typeof userinfo ==undefined || userinfo ==''  || userinfo ==null){
			return true;
		}
		_ajax(ajax_url + "Index/UserCart/getCart",{'uid':userinfo.uid},'post',function(ret){
			if(ret.status ==1){
			
				var strVar = "";
				$.each(ret.cartlist,function(k,v){
				    strVar += "<div class=\"cart_topicon\">";
				    strVar += "	<img src=\""+v['shop']['logo']+"\"/>"+v['shop']['name'];
				    strVar += "<\/div>";
				    strVar += "<div class=\"siteSearchlist\" style=\"background:#fff;\">";
				    strVar += "	<ul class=\"siteSearchul siteSearchuledit\">";
				    
				    //循环商品信息
				    $.each(v['good'],function(key,val){
				    	strVar += "		<li class=\"busi_fenleili\">";
				    	//判断是否失效
					    if(val['is_putaway']  ==1  && val['is_kucun'] != -1 ){
					    	strVar += "		<div class=\"busi_fenlei\" onclick=\"openGoodsDetail("+val['channel_id']+","+val['gid']+")\">";
					    }else{
					    	strVar += "		<div class=\"busi_fenlei\" >";
					    }
					    strVar += "			<a href=\"javascript:void(0)\"class=\"busi_fenleia\"><img src=\""+val['goods_img']+"\"><\/a>";
					    strVar += "			<div class=\"busi_fenleir\">";
					    strVar += "				<p class=\"busi_fenleirtxt\">";
					    strVar += "					<a href=\"#\" class=\"busi_fenleirtxta dy_dd\">"+val['goods_name']+"<\/a>";
					    strVar += "					<a href=\"#\" class=\"busi_fenleirtxta dy_dd\" style='color:#999;margin-top:5px;'>规格:"+val['attribute_name']+"<\/a>";
					    
					    strVar += "				<\/p>";
					    strVar += "				<p class=\"busi_fenleirrice\">";
					    strVar += "					<b class=\"busi_fenleirpriceb\">￥<\/b>"+val['goods_price'];
					    strVar += "				<\/p>";
					    strVar += "			<\/div>";
					    strVar += "		<\/div>";
					    strVar += "		<a href=\"javascript:;\" class=\"cartNum\">";
					    strVar += "		<span class=\"cartNuml cartNumldis cartlistdel\" attr-id='"+val['id']+"'   ><\/span>";
					    strVar += "		<span class=\"cartNumc\" id='cartlistnum_"+val['id']+"'     >"+val['num']+"<\/span>";
					    strVar += "		<span class=\"cartNumr cartlistadd\" attr-id='"+val['id']+"'     ><\/span>";
					    strVar += "		<\/a>";
					    
					    //判断是否失效
					    if(val['is_putaway']  ==1  && val['is_kucun'] != -1 ){
					    
					    	total_price+=  (+val['price']);
					    	
					    
					    	strVar += "		<div class=\"cartRadio\">";
					    	strVar += "			<input onclick=\"goodsInputCheck(this)\" id=\"a_pl"+val['id']+"\" attr-gid='"+val['gid']+"' food_type='"+val['food_type']+"'  attr-id='"+val['id']+"' attr-sid='"+val['sid']+"'  attr-attr='"+val['attribute']+"' attr-attr-str='"+val['attribute_name']+"'  attr-type='"+val['channel_id']+"'   attr-num='"+val['num']+"'  type=\"checkbox\" name=\"goods_input\" value=\""+val['goods_price']+"\" class=\"duo_checkbox03\">";
					   		strVar += "			<label for=\"a_pl"+val['id']+"\"><\/label>";
					   		strVar += "		<\/div>";
					    }else{
					    	strVar += "		<div class=\"cartRadio goods_edit\" style=\"color: #333;line-height: 1.7rem; padding-left: 0.1rem;\">";
						    strVar += "						失效";
						    strVar += "		<\/div>";
						    
						    strVar += "		<div class=\"cartRadio goods_edit_show\" style='display:none;'>";
					    	strVar += "			<input onclick=\"goodsInputCheck(this)\" id=\"a_pl"+val['id']+"\"  attr-id='"+val['id']+"'   type=\"checkbox\" name=\"goods_edit_input\" value=\""+val['goods_price']+"\" class=\"duo_checkbox03\">";
					   		strVar += "			<label for=\"a_pl"+val['id']+"\"><\/label>";
					   		strVar += "		<\/div>";
						    
						    $(".is_putaway").show();
					    }
					    strVar += "		<\/li>";
					    
					    
					 
				    });
				    
				    strVar += "	<\/ul>";
				    strVar += "<\/div>";
				    
				//    total_price = total_price.toFixed(2);
					/*api.sendEvent({
				        name:'cartPrice',
				         extra:{
			            	price:total_price.toFixed(2)
			            }
			        });*/
				});
				
				$(".is_putaway").hide();
				
				api.sendEvent({
			        name:frame+'cartempty',
			        extra:{
		            	empty:false
		            }
		        });
			}else{
				api.sendEvent({
	                name:'cart_body_edit_hide'
                });
				//空购物车
				emptyCart();
				api.sendEvent({
				        name:frame+'cartPrice',
				         extra:{
			            	price:total_price.toFixed(2)
			            }
			        });
				$(".is_putaway").hide();
				
			}
			$("#cartList").html(strVar);
			
			
			if(allCheck){
				shopCheckAll(allCheck);
			}
			api.refreshHeaderLoadDone();
			closeloading();
			
			
		});
	}
	
	//增加数量
	$(document).on("touchend",'.cartlistadd',function(){
		
		var id = $(this).attr('attr-id');
		
		var num= +$("#cartlistnum_"+id).html();
		
		//如果不是正整数 则为1
		if(!Number){
			num=1;
		}else{
			num +=1;
		}
		var count_num = num;
		//$(this).prev("span").html(num);
		//$("input[attr-id='"+id+"']").attr('attr-num',num);
		//购物车增加数量 服务端操作
		upCartNum(id,1,1,this,count_num);
		
	});
	
	//减少数量
	$(document).on("touchend",'.cartlistdel',function(){
		
		var id = $(this).attr('attr-id');
		
		
		var num= +$("#cartlistnum_"+id).html();
		if(num ==1){
			return true;
		}
		
		//如果不是正整数 则为1
		if(!Number){
			num=1;
		}else{
			num -=1;
		}
		var count_num = num;
		//$(this).next("span").html(num);
		//$("input[attr-id='"+id+"']").attr('attr-num',num);
		//购物车减少数量 服务端操作
		upCartNum(id,1,2,this,count_num);
	});
	
	
	/**
	 * 修改购物车数量 
	 */
	function upCartNum(id,num,type,el,count_num){
		//删除购物车
		_ajax(ajax_url + "Index/UserCart/upCartNum",{'uid':userinfo.uid,'id':id,'num':num,'type':type},'post',function(ret){
			if(ret.status ==1){
				//删除成功 从新加载购物车
				//getCart();
				
				if(type ==2){
					var newnum =count_num;
					$("input[attr-id='"+id+"']").attr('attr-num',newnum);
					$(el).next("span").html(newnum);
				}else{
					var newnum =count_num;
					$("input[attr-id='"+id+"']").attr('attr-num',newnum);
					$(el).prev("span").html(newnum);
				}
				
				calcAllPrice();
			}else if(ret.status == -2){
				getCart();
			}else{
				_toast(ret.msg);
			}
		});
			
		
	}
	
	/**
	 * 删除购物车商品信息 
	 */
	function delsCart(){
		//获取选择商品id
		var goods_id="";
		$("input[name='goods_input']:checked").each(function(){
			
			if(goods_id==""){
				goods_id=$(this).attr('attr-id');
			}else{
				goods_id+=","+$(this).attr('attr-id');
			}
		});
		
		//失效商品
		$("input[name='goods_edit_input']:checked").each(function(){
			if(goods_id==""){
				goods_id=$(this).attr('attr-id');
			}else{
				goods_id+=","+$(this).attr('attr-id');
			}
		});
		
		
		//删除购物车
		_ajax(ajax_url + "Index/UserCart/delCart",{'uid':userinfo.uid,'ids':goods_id},'post',function(ret){
			if(ret.status ==1){
				//删除成功 从新加载购物车
				total_price = 0;
				getCart();
				
				api.sendEvent({
	                name:'event_cart_num'
                });
			}else{
			
				_toast(ret.msg);
			}
		});
			
		
	}
	
	/**
	 * 单选计算价格 
	 */
	function goodsInputCheck(el){
		
		var that = $(el).prop('checked');
		if(that ==true){
			$(el).prop('checked',true);
		}else{
			$(el).prop('checked',false);
		}
		calcPrice();
	}
	
	/**
	 * 全选
	 * int id  店铺id
	 */
	function shopCheckAll(sta){

		if(sta){
			$("input[name='goods_input']").prop('checked',true);
		}else{
			$("input[name='goods_input']").removeAttr('checked');
		}
		calcPrice();

	}
	
	/**
	 * 编辑全选
	 * int id  店铺id
	 */
	function shopCheckAllEdit(sta){

		if(sta){
			$("input[name='goods_edit_input']").prop('checked',true);
		}else{
			$("input[name='goods_edit_input']").removeAttr('checked');
		}
		shopCheckAll(sta);

	}
	
	
	/**
	 * 计算所有价格
	 */
	function calcAllPrice(){
		
		var prices=0;
		$("input[name='goods_input']").each(function(){
			prices+=(+$(this).val()) * (+$(this).attr('attr-num'));
		});
		prices = prices.toFixed(2);
		api.sendEvent({
	        name:frame+'cartPrice',
	         extra:{
            	price:prices
            }
        });
        
        api.sendEvent({
	        name:'event_cart_num'
        });
		
		//$("#shopprice_"+id).html("共计计：￥"+price.toFixed(2)+"（不包含运费）");
	}
	
	/**
	 * 计算已选价格
	 */
	function calcPrice(){
		
		var prices=0;
		$("input[name='goods_input']:checked").each(function(){
			prices+=(+$(this).val()) * (+$(this).attr('attr-num'));
		});
		prices = prices.toFixed(2);
		api.sendEvent({
	        name:frame+'cartPrice',
	         extra:{
            	price:prices
            }
        });
        api.sendEvent({
	        name:'event_cart_num'
        });
		
		//$("#shopprice_"+id).html("共计计：￥"+price.toFixed(2)+"（不包含运费）");
	}
	
	
	
	
	/**
	 * 去结算 
	 */
	function order(){
		if(typeof userinfo ==undefined || userinfo ==''  || userinfo ==null){
			_openWinByUrl('login','login');
			return false;
		}
			
		var goods_id ="";  //商品id
		var goods_num="";  //商品数量
		var goods_attr=""; //商品属性
		var goods_attr_str =""; //商品熟属性描述
		var goods_type ="";//商品所属类型  商城 超市
		var goods_sid  =""; //商品所属店铺id
		var goods_price=""; //商品属性价格
		
		var food_type ="";  //餐饮类型
		
		$("input[name='goods_input']:checked").each(function(){
			//获取商品id
			if(goods_id==""){
				goods_price=$(this).val();
				
				goods_id=$(this).attr('attr-gid');
				goods_num=$(this).attr('attr-num');
				
				goods_attr=$(this).attr('attr-attr');
				goods_attr_str=$(this).attr('attr-attr-str');
				goods_type=$(this).attr('attr-type');
				goods_sid=$(this).attr('attr-sid');
				
				food_type = $(this).attr('food_type');
			}else{
				goods_price+=","+$(this).val();
				goods_id+=","+$(this).attr('attr-gid');
				goods_num+=","+$(this).attr('attr-num');
				goods_attr+=","+$(this).attr('attr-attr');
				goods_attr_str+=","+$(this).attr('attr-attr-str');
				goods_type+=","+$(this).attr('attr-type');
				goods_sid+=","+$(this).attr('attr-sid');
				
				food_type += ","+$(this).attr('food_type');
			}
		});
		
		if(goods_id==''){
			_toast('请选择商品');
			return false;
		}
		
		_openWinByUrl('mall_order','order/mall_order',{
			'goods_id':goods_id,
			'goods_num':goods_num,
			'goods_sid':goods_sid,
			'goods_attr':goods_attr,
			'goods_attr_str':goods_attr_str,
			'goods_type':goods_type,
			'goods_price':goods_price,
			'food_type'  :food_type
		})
		
	}
	
	
	//跳转详情
		function openGoodsDetail(channl,id){
			if(channl==1){
				var name='mall_goodsdetail';
				var url='./mall/mall_goodsdetail';
				var param={goods_id:id};
			}
			if(channl==2){
				var name='super_goodsdetail';
				var url='./super/super_goodsdetail';
				var param={goods_id:id};
			}
			
			_openWinByUrl(name,url,param);
		}
		
	/**
	 * 空购物车 
	 */
	function emptyCart(){
		api.sendEvent({
	        name:'refresh_cartinfo'
        });
		var strVar = "";
	    strVar += "<div class=\"wp_100\">";
	    strVar += "	<div class=\"reg_fail\">";
	    strVar += "		<p class=\"reg_failimg\">";
	    strVar += "			<img src=\"../images/empty_cart.png\" style=\"width: 1.25rem; height: 1.25rem;\">";
	    strVar += "		<\/p>";
	    strVar += "	<\/div>";
	    strVar += "	<p class=\"reg_failtxt\" style=\"text-align: center; padding-top: 0.1rem;\">";
	    strVar += "		购物车是空的哦";
	    strVar += "	<\/p>";
	    strVar += "<\/div>";
	    
	    $("#cartList").html(strVar);
	    api.sendEvent({
	        name:frame+'cartempty',
	        extra:{
            	empty:true
            }
        });
	}
</script>
</html>